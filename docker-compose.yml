services:
  postgres:
    image: postgres:15-alpine
    container_name: brazilian_market_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-dataeng}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dataeng123}
      POSTGRES_DB: ${POSTGRES_DB:-brazilian_market}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-dataeng} -d ${POSTGRES_DB:-brazilian_market}"]
      interval: 10s
      timeout: 5s
      retries: 5

  airflow-init:
    build:
      context: .
      dockerfile: docker/Dockerfile.airflow
    image: brazilian-market-airflow:2.8.0
    container_name: airflow_init
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-dataeng}:${POSTGRES_PASSWORD:-dataeng123}@postgres:5432/${POSTGRES_DB:-brazilian_market}
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY:-}
      _AIRFLOW_DB_MIGRATE: 'true'
      _AIRFLOW_WWW_USER_CREATE: 'true'
      _AIRFLOW_WWW_USER_USERNAME: ${AIRFLOW_ADMIN_USER:-admin}
      _AIRFLOW_WWW_USER_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD:-admin}
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db init
        airflow users create \
          --username ${AIRFLOW_ADMIN_USER:-admin} \
          --password ${AIRFLOW_ADMIN_PASSWORD:-admin} \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com || true
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - ./airflow/plugins:/opt/airflow/plugins

  airflow-webserver:
    image: brazilian-market-airflow:2.8.0
    container_name: airflow_webserver
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    restart: unless-stopped
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-dataeng}:${POSTGRES_PASSWORD:-dataeng123}@postgres:5432/${POSTGRES_DB:-brazilian_market}
      AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: 'true'
      AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE: America/Sao_Paulo
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-dataeng}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dataeng123}
      POSTGRES_DB: ${POSTGRES_DB:-brazilian_market}
    ports:
      - "${AIRFLOW_WEBSERVER_PORT:-8080}:8080"
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - ./airflow/plugins:/opt/airflow/plugins
      - ./extract:/opt/airflow/extract
      - ./load:/opt/airflow/load
      - ./dbt_project:/opt/airflow/dbt_project
    command: webserver
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  airflow-scheduler:
    image: brazilian-market-airflow:2.8.0
    container_name: airflow_scheduler
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    restart: unless-stopped
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-dataeng}:${POSTGRES_PASSWORD:-dataeng123}@postgres:5432/${POSTGRES_DB:-brazilian_market}
      AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-dataeng}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dataeng123}
      POSTGRES_DB: ${POSTGRES_DB:-brazilian_market}
      PYTHONPATH: /opt/airflow
      DBT_PROFILES_DIR: /opt/airflow/dbt_project
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - ./airflow/plugins:/opt/airflow/plugins
      - ./extract:/opt/airflow/extract
      - ./load:/opt/airflow/load
      - ./dbt_project:/opt/airflow/dbt_project
      - ./scripts:/opt/airflow/scripts
      - ./logs:/opt/airflow/logs/extraction
    command: scheduler

  dbt:
    image: ghcr.io/dbt-labs/dbt-postgres:1.7.4
    container_name: dbt_runner
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-dataeng}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dataeng123}
      POSTGRES_DB: ${POSTGRES_DB:-brazilian_market}
      DBT_PROFILES_DIR: /usr/app/dbt_project
    volumes:
      - ./dbt_project:/usr/app/dbt_project
    working_dir: /usr/app/dbt_project
    entrypoint: ["/bin/bash", "-c", "tail -f /dev/null"]
    # Use: sudo docker exec dbt_runner dbt run
    # Or:  sudo docker exec dbt_runner dbt test

  dashboard:
    build:
      context: .
      dockerfile: docker/Dockerfile.dashboard
    container_name: market_dashboard
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-dataeng}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dataeng123}
      POSTGRES_DB: ${POSTGRES_DB:-brazilian_market}
    ports:
      - "${DASHBOARD_PORT:-8501}:8501"
    volumes:
      - ./dashboard:/app/dashboard
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local

networks:
  default:
    name: brazilian_market_network
